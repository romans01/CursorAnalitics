# Runbook: Операционная поддержка системы

## Назначение документа
Руководство для команды технической поддержки по эксплуатации, мониторингу и устранению неполадок в продуктивной среде.

## Общая информация о системе

### Архитектура системы
**Компоненты:**
- **Frontend:** React.js приложение (порты 3000, 3001)
- **Backend API:** Node.js сервисы (порты 8000-8003)
- **База данных:** PostgreSQL 13 (порт 5432)
- **Кэш:** Redis (порт 6379)
- **Очереди:** RabbitMQ (порт 5672)
- **Мониторинг:** Grafana + Prometheus

**Среды:**
- **Production:** prod.company.com
- **Staging:** staging.company.com  
- **Development:** dev.company.com

### Ключевые контакты
| Роль | Контакт | Телефон | Email | Время доступности |
|------|---------|---------|-------|-------------------|
| Tech Lead | [ФИО] | +7-xxx-xxx-xx-xx | tech.lead@company.com | 24/7 для критичных |
| DevOps Engineer | [ФИО] | +7-xxx-xxx-xx-xx | devops@company.com | Рабочие часы |
| Database Admin | [ФИО] | +7-xxx-xxx-xx-xx | dba@company.com | 24/7 для критичных |
| Product Manager | [ФИО] | +7-xxx-xxx-xx-xx | pm@company.com | Рабочие часы |

## Мониторинг и алертинг

### Ключевые метрики для мониторинга
**Производительность:**
- Время отклика API: < 500ms (среднее)
- Время загрузки страниц: < 3 секунды
- Пропускная способность: > 1000 RPS
- Использование CPU: < 70%
- Использование RAM: < 80%
- Использование диска: < 85%

**Доступность:**
- Uptime системы: > 99.5%
- Доступность базы данных: > 99.9%
- Успешность HTTP запросов: > 99%

**Бизнес-метрики:**
- Активные пользователи онлайн
- Количество транзакций в час
- Конверсия ключевых процессов

### Настройка алертов
**Критичные алерты (немедленная реакция):**
- Недоступность системы > 2 минут
- Ошибки базы данных > 10% запросов
- Использование диска > 90%
- Падение любого критичного сервиса

**Предупреждающие алерты:**
- Время отклика > 1 секунда
- Использование CPU > 80%
- Количество ошибок > 5%
- Низкая скорость обработки очередей

### Инструменты мониторинга
- **Grafana Dashboard:** http://monitoring.company.com
- **Prometheus:** http://prometheus.company.com:9090
- **Application Logs:** /var/log/app/
- **System Logs:** journalctl -u service-name

## Стандартные операционные процедуры

### Ежедневные проверки (Daily Health Check)
**Время выполнения:** 9:00 каждый день  
**Ответственный:** Дежурный инженер  
**Длительность:** 15 минут

**Чек-лист:**
- [ ] Проверить статус всех сервисов
- [ ] Просмотреть дашборды мониторинга
- [ ] Проверить логи на наличие ошибок
- [ ] Убедиться в работе резервного копирования
- [ ] Проверить свободное место на дисках
- [ ] Просмотреть очереди сообщений
- [ ] Проверить статус SSL сертификатов

**Команды для проверки:**
```bash
# Статус сервисов
systemctl status nginx
systemctl status app-backend
systemctl status postgresql
systemctl status redis

# Проверка дисков
df -h

# Проверка логов
tail -100 /var/log/app/error.log

# Проверка процессов
top -n 1 | head -20
```

### Еженедельные задачи
**Время выполнения:** Понедельник, 10:00  
**Ответственный:** DevOps инженер

- [ ] Анализ трендов производительности
- [ ] Проверка и обновление мониторинга
- [ ] Ревью логов безопасности
- [ ] Планирование обновлений
- [ ] Тестирование процедур восстановления

### Месячные задачи
- [ ] Полное тестирование disaster recovery
- [ ] Ревью и обновление документации
- [ ] Анализ capacity planning
- [ ] Аудит безопасности
- [ ] Обновление runbook

## Процедуры устранения неполадок

### Проблема 1: Высокое время отклика системы

**Симптомы:**
- Время отклика API > 2 секунд
- Жалобы пользователей на медленную работу
- Алерт "High Response Time"

**Диагностика:**
1. **Проверить нагрузку на сервер:**
   ```bash
   htop
   iostat -x 1 5
   ```

2. **Проверить базу данных:**
   ```sql
   SELECT query, state, query_start 
   FROM pg_stat_activity 
   WHERE state != 'idle' 
   ORDER BY query_start;
   ```

3. **Проверить логи приложения:**
   ```bash
   tail -f /var/log/app/app.log | grep ERROR
   ```

**Возможные решения:**
- **Высокая нагрузка CPU:** Перезапустить тяжелые процессы
- **Медленные запросы БД:** Остановить длинные запросы, проверить индексы
- **Переполнение памяти:** Перезапустить сервисы, увеличить лимиты
- **Проблемы с сетью:** Проверить соединения, перезапустить сетевые сервисы

**Эскалация:**
Если проблема не решается в течение 30 минут → связаться с Tech Lead

### Проблема 2: Недоступность системы

**Симптомы:**
- HTTP 5xx ошибки
- Система не отвечает на запросы
- Алерт "Service Down"

**Немедленные действия:**
1. **Проверить статус сервисов:**
   ```bash
   systemctl status nginx
   systemctl status app-backend
   ```

2. **Проверить логи:**
   ```bash
   journalctl -u app-backend -n 50
   ```

3. **Попробовать перезапуск:**
   ```bash
   systemctl restart app-backend
   systemctl restart nginx
   ```

**Дальнейшая диагностика:**
- Проверить доступность базы данных
- Проверить свободное место на диске
- Проверить сетевые соединения
- Анализировать логи ошибок

### Проблема 3: Проблемы с базой данных

**Симптомы:**
- Ошибки подключения к БД
- Медленные запросы
- Блокировки транзакций

**Диагностика:**
```sql
-- Проверить активные соединения
SELECT count(*) FROM pg_stat_activity;

-- Найти заблокированные запросы
SELECT blocked_locks.pid AS blocked_pid,
       blocked_activity.usename AS blocked_user,
       blocking_locks.pid AS blocking_pid,
       blocking_activity.usename AS blocking_user,
       blocked_activity.query AS blocked_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity 
  ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks 
  ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity 
  ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

**Решения:**
- Остановить проблемные запросы: `SELECT pg_terminate_backend(pid);`
- Перезапустить PostgreSQL: `systemctl restart postgresql`
- Проверить и освободить место на диске

## Процедуры развертывания

### Стандартное развертывание (Production)
**Время:** Вторник/Четверг, 02:00 MSK  
**Ответственный:** DevOps Engineer + Tech Lead

**Pre-deployment чек-лист:**
- [ ] Код прошел все тесты в staging
- [ ] Создан backup базы данных
- [ ] Уведомлены заинтересованные стороны
- [ ] Подготовлен план отката
- [ ] Проверена готовность monitoring

**Процедура развертывания:**
1. **Подготовка:**
   ```bash
   # Создание backup
   pg_dump production_db > backup_$(date +%Y%m%d_%H%M).sql
   
   # Остановка приложения
   systemctl stop app-backend
   ```

2. **Развертывание:**
   ```bash
   # Обновление кода
   cd /opt/app
   git pull origin main
   
   # Установка зависимостей
   npm install --production
   
   # Миграции БД (если есть)
   npm run migrate
   ```

3. **Запуск и проверка:**
   ```bash
   # Запуск приложения
   systemctl start app-backend
   
   # Проверка статуса
   systemctl status app-backend
   
   # Проверка логов
   tail -f /var/log/app/app.log
   ```

4. **Smoke тесты:**
   - Проверить доступность главной страницы
   - Тестовый вход в систему
   - Проверка ключевых API endpoints
   - Мониторинг метрик в течение 30 минут

### Экстренное развертывание (Hotfix)
**Условия применения:**
- Критичные баги в production
- Проблемы безопасности
- Критичные проблемы производительности

**Процедура:**
1. Получить одобрение от Tech Lead и Product Manager
2. Развертывание только исправления (не полный релиз)
3. Ускоренное тестирование в staging
4. Немедленное развертывание в production
5. Усиленный мониторинг в течение 2 часов

## Процедуры резервного копирования и восстановления

### Резервное копирование

**База данных (ежедневно в 03:00):**
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M)
pg_dump -h localhost -U postgres production_db > /backups/db/backup_$DATE.sql
gzip /backups/db/backup_$DATE.sql

# Очистка старых backup'ов (старше 30 дней)
find /backups/db -name "*.gz" -mtime +30 -delete
```

**Файлы приложения (еженедельно):**
```bash
tar -czf /backups/app/app_files_$(date +%Y%m%d).tar.gz /opt/app
```

**Конфигурации системы (ежемесячно):**
```bash
tar -czf /backups/config/system_config_$(date +%Y%m%d).tar.gz   /etc/nginx   /etc/systemd/system   /etc/postgresql
```

### Восстановление из backup

**Восстановление базы данных:**
```bash
# Остановить приложение
systemctl stop app-backend

# Восстановить БД
gunzip -c /backups/db/backup_YYYYMMDD_HHMM.sql.gz | psql -U postgres production_db

# Запустить приложение
systemctl start app-backend
```

**Полное восстановление системы:**
1. Восстановить ОС из образа
2. Восстановить конфигурации из backup
3. Восстановить файлы приложения
4. Восстановить базу данных
5. Проверить работоспособность всех сервисов

## Процедуры безопасности

### Реагирование на инциденты безопасности

**Классификация инцидентов:**
- **P0 (Критичный):** Компрометация системы, утечка данных
- **P1 (Высокий):** Подозрительная активность, попытки взлома
- **P2 (Средний):** Нарушения политик безопасности
- **P3 (Низкий):** Потенциальные уязвимости

**Процедура реагирования:**
1. **Немедленно (0-15 минут):**
   - Изолировать скомпрометированные системы
   - Уведомить команду безопасности
   - Зафиксировать время и обстоятельства

2. **Краткосрочно (15-60 минут):**
   - Провести первичную оценку ущерба
   - Собрать логи и артефакты
   - Уведомить менеджмент
   - Начать расследование

3. **Среднесрочно (1-24 часа):**
   - Устранить уязвимости
   - Восстановить нормальную работу
   - Подготовить отчет об инциденте
   - Обновить процедуры безопасности

### Регулярные проверки безопасности
- **Еженедельно:** Анализ логов безопасности
- **Ежемесячно:** Проверка обновлений безопасности
- **Ежеквартально:** Аудит доступов и привилегий
- **Ежегодно:** Полный аудит безопасности

## Контакты экстренной связи

### Внутренние контакты
- **Дежурный инженер:** +7-xxx-xxx-xx-xx
- **Tech Lead:** +7-xxx-xxx-xx-xx  
- **DevOps Lead:** +7-xxx-xxx-xx-xx
- **Security Officer:** +7-xxx-xxx-xx-xx

### Внешние контакты
- **Хостинг провайдер:** +7-xxx-xxx-xx-xx
- **Интернет провайдер:** +7-xxx-xxx-xx-xx
- **Вендор мониторинга:** +7-xxx-xxx-xx-xx

## Документация и ресурсы

### Внутренние ресурсы
- **Wiki:** http://wiki.company.com
- **Мониторинг:** http://monitoring.company.com
- **Логи:** http://logs.company.com
- **CI/CD:** http://ci.company.com

### Внешние ресурсы
- **PostgreSQL документация:** https://postgresql.org/docs
- **Redis документация:** https://redis.io/documentation
- **Nginx документация:** https://nginx.org/docs

---
**Версия:** 2.1  
**Последнее обновление:** [дата]  
**Ответственный за обновление:** DevOps Team  
**Следующий пересмотр:** [дата + 3 месяца]
