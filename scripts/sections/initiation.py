#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Модуль создания раздела 01_Инициация_и_контекст
"""

from pathlib import Path


def write_text_file(path: Path, content: str) -> None:
    """Записывает текстовый файл в UTF-8"""
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, 'w', encoding='utf-8') as f:
        f.write(content)


def create_section(root: Path, as_template: bool = False) -> None:
    """Создает раздел 01_Инициация_и_контекст"""
    
    section_path = root / '01_Инициация_и_контекст'
    
    # Создаем подпапки
    (section_path / 'интервью').mkdir(parents=True, exist_ok=True)
    (section_path / 'карты_процессов').mkdir(parents=True, exist_ok=True)
    
    if as_template:
        write_text_file(section_path / 'текущее_состояние.md', """# Текущее состояние (As-Is)

## Обзор процессов
Описание существующих бизнес-процессов, которые затрагивает проект.

### Процесс 1: [Название]
**Цель процесса:** Зачем выполняется  
**Входы:** Что поступает на вход  
**Выходы:** Что получается на выходе  
**Участники:** Кто участвует в процессе  

**Текущие шаги:**
1. [Шаг 1] - время выполнения, ответственный
2. [Шаг 2] - время выполнения, ответственный
3. [Шаг 3] - время выполнения, ответственный

**Проблемы и боли:**
- ❌ Проблема 1: описание и влияние
- ❌ Проблема 2: описание и влияние
- ❌ Проблема 3: описание и влияние

## Используемые системы

| Система | Назначение | Пользователи | Проблемы |
|---------|------------|--------------|----------|
| [Система 1] | Для чего используется | Кто использует | Основные проблемы |
| [Система 2] | Для чего используется | Кто использует | Основные проблемы |

## Данные и отчетность

### Источники данных
- **[Источник 1]:** что содержит, как часто обновляется
- **[Источник 2]:** что содержит, как часто обновляется

### Существующие отчеты
- **[Отчет 1]:** назначение, частота, получатели
- **[Отчет 2]:** назначение, частота, получатели

### Проблемы с данными
- Дублирование информации
- Ручной сбор данных
- Задержки в получении отчетов
- Разные версии "правды"

## Ключевые выводы
1. **Основная проблема:** краткое описание главной боли
2. **Потенциал улучшений:** что можно улучшить
3. **Ограничения:** что нельзя изменить
4. **Возможности:** новые возможности для бизнеса
""")
        
        # Шаблон интервью
        write_text_file(section_path / 'интервью/шаблон_интервью.md', """# Шаблон интервью с заинтересованными сторонами

## Подготовка к интервью

### Информация об участнике
**ФИО:** [Имя участника]  
**Должность:** [Должность]  
**Роль в проекте:** [Заказчик/Пользователь/Эксперт]  
**Дата интервью:** [дата]  
**Длительность:** [планируемое время]

### Цели интервью
- [ ] Понять текущие процессы в области ответственности
- [ ] Выявить основные проблемы и боли
- [ ] Определить ожидания от проекта
- [ ] Собрать функциональные требования
- [ ] Уточнить критерии успеха

## Вопросы для интервью

### 1. Контекст и роль
- Расскажите о своей роли и области ответственности
- Как ваша работа связана с [предметная область проекта]?
- Кто еще участвует в этих процессах?

### 2. Текущее состояние
- Опишите, как сейчас происходит [ключевой процесс]
- Какие системы/инструменты вы используете?
- Сколько времени занимает [процесс]?
- Как часто возникают проблемы?

### 3. Проблемы и боли
- С какими основными проблемами вы сталкиваетесь?
- Что отнимает больше всего времени?
- Какие задачи выполняете вручную?
- Что хотелось бы автоматизировать?

### 4. Ожидания от проекта
- Что должно измениться после внедрения решения?
- Как вы поймете, что проект успешен?
- Какой результат для вас критически важен?
- Что было бы "приятным бонусом"?

### 5. Требования и ограничения
- Какие функции должны быть обязательно?
- Есть ли ограничения по времени/бюджету?
- Какие интеграции необходимы?
- Есть ли требования по безопасности?

### 6. Пользователи и сценарии
- Кто будет основными пользователями?
- Как часто будут пользоваться системой?
- В каких условиях будет использоваться?
- Какой уровень подготовки пользователей?

## Заметки интервью
[Место для записи ответов и наблюдений]

## Действия после интервью
- [ ] Обработать заметки в течение 24 часов
- [ ] Выделить ключевые требования
- [ ] Зафиксировать противоречия для уточнения
- [ ] Отправить краткую сводку участнику на проверку
- [ ] Запланировать дополнительные интервью при необходимости

## Выводы
**Ключевые инсайты:**
1. [Инсайт 1]
2. [Инсайт 2]

**Требования для дальнейшей проработки:**
- [Требование 1]
- [Требование 2]

**Риски и вопросы:**
- [Риск/вопрос 1]
- [Риск/вопрос 2]
""")
        
    else:
        # Базовые файлы
        write_text_file(section_path / 'текущее_состояние.md', """# Текущее состояние

## Процессы
Описание существующих бизнес-процессов.

## Системы  
Используемые системы и их проблемы.

## Данные
Источники данных и качество.

## Проблемы
Основные боли и ограничения.
""")
    
    # Общие файлы
    write_text_file(section_path / 'цели_и_метрики.md', """# Цели и метрики проекта

## SMART-цели

### Цель 1: [Название]
- **S (Specific):** Конкретное описание цели
- **M (Measurable):** Как измерить (метрика)
- **A (Achievable):** Реалистичность достижения  
- **R (Relevant):** Связь с бизнес-стратегией
- **T (Time-bound):** Временные рамки

**Базовое значение:** [текущее состояние]  
**Целевое значение:** [к чему стремимся]  
**Способ измерения:** [как будем отслеживать]

## KPI проекта

| Метрика | Текущее значение | Целевое значение | Ответственный | Срок |
|---------|------------------|------------------|---------------|------|
| [Метрика 1] | [значение] | [цель] | [кто отвечает] | [когда] |
| [Метрика 2] | [значение] | [цель] | [кто отвечает] | [когда] |

## OKR (Objectives and Key Results)

### Objective: [Высокоуровневая цель]

**Key Results:**
1. [Измеримый результат 1] - прогресс: __/100%
2. [Измеримый результат 2] - прогресс: __/100%  
3. [Измеримый результат 3] - прогресс: __/100%

## Связь с бизнес-стратегией
Как цели проекта поддерживают общую стратегию компании.
""")
    
    write_text_file(section_path / 'риски_и_допущения.md', """# Управление рисками и допущения

## Реестр рисков

| ID | Риск | Вероятность | Влияние | Рейтинг | Владелец | Статус |
|----|------|-------------|---------|---------|----------|--------|
| R01 | [Описание риска] | Высокая/Средняя/Низкая | Высокое/Среднее/Низкое | [число] | [ФИО] | Активный |

### Детализация рисков

#### R01: [Название риска]
**Описание:** Подробное описание риска и его потенциального влияния

**Индикаторы:** Как понять, что риск материализуется
- Индикатор 1
- Индикатор 2

**Стратегия реагирования:** Избежать/Смягчить/Передать/Принять

**План митигации:**
1. Превентивные меры (что делаем заранее)
2. Реактивные меры (что делаем, если риск наступил)
3. План "Б" (запасной вариант)

**Мониторинг:** Как и как часто отслеживаем

## Допущения проекта

| ID | Допущение | Влияние на проект | Ответственный за валидацию |
|----|-----------|-------------------|----------------------------|
| A01 | [Описание допущения] | [Как влияет, если неверно] | [Кто проверяет] |

### Валидация допущений
**A01:** [Описание]
- **Способ проверки:** Как валидировать допущение
- **Периодичность:** Как часто проверять
- **План действий:** Что делать, если допущение неверно

## SWOT-анализ проекта

### Strengths (Сильные стороны)
- [Сильная сторона 1]
- [Сильная сторона 2]

### Weaknesses (Слабые стороны)  
- [Слабая сторона 1]
- [Слабая сторона 2]

### Opportunities (Возможности)
- [Возможность 1]
- [Возможность 2]

### Threats (Угрозы)
- [Угроза 1] 
- [Угроза 2]

## Мониторинг и отчетность
- **Частота обзора рисков:** еженедельно/ежемесячно
- **Ответственный:** Risk Owner
- **Эскалация:** когда и кому сообщать о критичных рисках
""")
    
    # Добавляем примеры для режима шаблона
    if as_template:
        # Пример карты процессов
        write_text_file(section_path / 'карты_процессов/README.md', """# Карты процессов

## Назначение
В этой папке хранятся диаграммы и описания бизнес-процессов, которые затрагивает проект.

## Типы артефактов

### BPMN диаграммы
- `current_process.bpmn` — текущий процесс (As-Is)
- `future_process.bpmn` — целевой процесс (To-Be)
- `process_comparison.md` — сравнительный анализ

### Схемы взаимодействия
- `stakeholder_interaction.drawio` — схема взаимодействия участников
- `system_integration.png` — диаграмма интеграций систем
- `data_flow.drawio` — схема потоков данных

### Описания процессов
- `process_description.md` — детальное описание процесса
- `bottlenecks_analysis.md` — анализ узких мест
- `improvement_opportunities.md` — возможности для улучшения

## Инструменты для создания
- **BPMN:** Camunda Modeler, Bizagi, Draw.io
- **Диаграммы:** Draw.io, Lucidchart, Visio
- **Схемы данных:** PlantUML, Mermaid

## Шаблон описания процесса

### Название процесса: [Название]

**Цель:** Зачем выполняется процесс  
**Входы:** Что поступает на вход  
**Выходы:** Что получается на выходе  
**Участники:** Кто участвует в процессе  

**Шаги процесса:**
1. [Шаг 1] - ответственный, время выполнения
2. [Шаг 2] - ответственный, время выполнения
3. [Шаг 3] - ответственный, время выполнения

**Проблемы:**
- Проблема 1: описание и влияние
- Проблема 2: описание и влияние

**Метрики:**
- Время выполнения: X часов
- Стоимость: Y рублей
- Качество: Z% без ошибок
""")
        
        # Пример карты процесса
        write_text_file(section_path / 'карты_процессов/process_example.md', """# Пример: Процесс подготовки отчета

## Общая информация
**Название:** Еженедельный отчет по продажам  
**Частота:** Еженедельно, по понедельникам  
**Участники:** Аналитик, Менеджер по продажам, Директор  

## Текущий процесс (As-Is)

### Шаги
1. **Сбор данных** (Аналитик, 2 часа)
   - Выгрузка из CRM системы
   - Выгрузка из ERP системы
   - Сверка данных вручную

2. **Анализ данных** (Аналитик, 3 часа)
   - Расчет показателей в Excel
   - Создание графиков
   - Выявление трендов

3. **Подготовка отчета** (Аналитик, 1 час)
   - Оформление в PowerPoint
   - Добавление комментариев
   - Проверка на ошибки

4. **Согласование** (Менеджер, 30 мин)
   - Проверка данных
   - Добавление комментариев
   - Утверждение

5. **Распространение** (Аналитик, 15 мин)
   - Отправка по email
   - Размещение в общей папке

### Проблемы текущего процесса
- ❌ Ручной сбор данных занимает много времени
- ❌ Высокий риск ошибок при сверке
- ❌ Дублирование работы между системами
- ❌ Задержки из-за недоступности систем

### Метрики
- **Общее время:** 6 часов 45 минут
- **Трудозатраты:** 1 человеко-день
- **Частота ошибок:** 15% отчетов требуют исправлений

## Целевой процесс (To-Be)

### Автоматизированные шаги
1. **Автоматический сбор данных** (Система, 10 мин)
   - ETL процесс из CRM и ERP
   - Валидация данных
   - Загрузка в DWH

2. **Генерация отчета** (Система, 5 мин)
   - Расчет показателей по шаблону
   - Создание графиков
   - Формирование PDF

3. **Проверка и утверждение** (Менеджер, 15 мин)
   - Просмотр сгенерированного отчета
   - Добавление комментариев при необходимости
   - Утверждение

4. **Автоматическая рассылка** (Система, 1 мин)
   - Отправка утвержденного отчета
   - Уведомления получателям

### Ожидаемые улучшения
- ✅ Сокращение времени с 6ч 45м до 30 минут
- ✅ Снижение ошибок до 2%
- ✅ Освобождение аналитика для других задач
- ✅ Стандартизация формата отчетов
""")
    else:
        # Базовые описания для пустых папок
        write_text_file(section_path / 'карты_процессов/README.md', """# Карты процессов

Здесь размещаются:
- BPMN диаграммы текущих и целевых процессов
- Схемы взаимодействия участников
- Диаграммы потоков данных
- Описания процессов и анализ узких мест
""")
    
    print(f"✅ Создан раздел: 01_Инициация_и_контекст ({'с примерами' if as_template else 'базовый'})")
